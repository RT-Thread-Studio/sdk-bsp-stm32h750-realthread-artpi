# 使用前必读

## 1、 必要了解（关于 LD3320）

### 1、LD3320特点

​	`LD3320`芯片是一款“语音识别”专用芯片，由 `ICRoute` 公司设计生产。该芯片集成了语音识别处理器和一些外部电路，包括 `AD`、`DA` 转换器、麦克风接口、声音输出接口等。本芯片在设计上注重节能与高效，不需要外接任何的辅助芯片如 `Flash`、`RAM `等，直接集成在现有的产品中即可以实现`语音识别`/`声控`/`人机对话功能`。并且，识别的关键词语列表是可以任意动态编辑的。

### 2、功能介绍

主要特征有：

- 通过 `ICRoute` 公司特有的快速而稳定的优化算法，完成非特定人语音识别。不需要用户事先训练和录音，识别准确率 95%。 

- 不需要外接任何辅助的 `Flash` 芯片，`RAM` 芯片和 `AD` 芯片，就可以完成语音识别功能。真正提供了单芯片语音识别解决方案。

- 每次识别最多可以设置 50 项候选识别句，每个识别句可以是单字，词组或短句，**长度为不超过 10 个汉字或者 79 个字节的拼音串**。另一方面，识别句内容可以动态编辑修改, 因此可由一个系统支持多种场景。 

-  芯片内部已经准备了 `16 位 A/D 转换器`、`16 位 D/A 转换器`和`功放电路`，`麦克风`、`立体声耳机`和`单声道喇叭`可以很方便地和芯片管脚连接。立体声耳机接口的输出功率为 20mW，而喇叭接口的输出功率为 550mW，能产生清晰响亮的声音。

- 支持并行和串行接口，串行方式可以简化与其他模块的连接。

- 可设置为`休眠状态`，而且可以方便地激活。

- 支持 MP3 播放功能，无需外围辅助器件，主控 `MCU `将 `MP3 `数据依次送入`LD3320` 芯片内部就可以从芯片的相应` PIN` 输出声音。产品设计可以选择从立体声的耳机或者单声道喇叭来获得声音输出。支持`MPEG1(ISO/IEC11172-3)`, `MPEG2(ISO/IEC13818-3)` 和 `MPEG 2.5 layer3` 等格式。

- 工作供电为 3.3V，如果用于便携式系统，使用 3 节 AA 电池就可以满足。

### 3. 当前驱动特点

- 支持`ASR`，`MP3`模式驱动
- 采用信号量的方式，信号量将阻塞ld3320_run这个函数，在中断中会释放信号量，之后会将ld3320_run进入就绪态。
- 采用中断方式，占用时间少。
- ASR模式下，run执行一次最多需要`163us+100us*(命令条数)`

## 2、使用流程

​	用户首先进行配置和初始化，以获得一个完整的`ld3320`对象， 然后在线程中使用函数`void ld3320_run(ld3320_t ld3320, uint8_t mode) `运行该对象即可。如果是ASR模式，对象会在运行期间调用用户的回调函数。如果是MP3模式，对象会播放完一首完整的歌。

### 1、配置和初始化

> ASR模式

```c
static ld3320_t _ld3320;
_ld3320 = ld3320_create("spi2a", LD3320_PIN_NONE, LD3320_RST, LD3320_IRQ, LD3320_MODE_ASR);
ld3320_set_asr_over_callback(_ld3320, ld3320_a_asr_over_callback);

ld3320_addcommand_tolist(_ld3320, "kai shi", 1);
ld3320_addcommand_tolist(_ld3320, "guan bi", 2);
ld3320_addcommand_tolist(_ld3320, "zan ting", 3);
ld3320_addcommand_fromlist(_ld3320);

ld3320_asr_start(_ld3320);
```

在回调函数中

```c
static void ld3320_a_asr_over_callback(uint8_t num)
{
    switch (num)
    {
        case 1:/* 开始 */
        
            break;
        case 2:/* 关闭 */
        
            break;
        case 3:/* 暂停 */
        
            break;
        default:
            break;
    }
}
```

------

> MP3模式

```c
static ld3320_t _ld3320;
_ld3320 = ld3320_create("spi2a", LD3320_PIN_NONE, LD3320_RST, LD3320_IRQ, LD3320_MODE_MP3);
ld3320_set_mp3_file_path(_ld3320, "/test.mp3");
ld3320_mp3_start(_ld3320);
```

### 2、运行对象

直接调用即可，需要注意的是run 会阻塞线程。

> ASR模式

```c
...
ld3320_run(ld3320, LD3320_MODE_ASR)
...
```

------

> MP3模式

```c
...
ld3320_run(ld3320, LD3320_MODE_MP3)
...
```

